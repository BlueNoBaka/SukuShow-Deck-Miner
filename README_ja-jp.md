# SukuShow Deck Miner

[
Link！Like！ラブライブ！](https://www.lovelive-anime.jp/hasunosora/system/) (リンクラ) 内のリズムゲームモード、スクールアイドルショウ (スクショウ) 向けのデッキシミュレーターおよび最適化ツールです。

---

**[English](README.md) | [简体中文](README_zh-cn.md) | [日本語](README_ja-jp.md)**

---

## 🚀 クイックスタート

### 🛞 動作環境

- **Python バージョン**:  
  `match ... case ...` ステートメントを使用しているため、本プロジェクトは **Python 3.10 以降** が必須です。  
  **最適なパフォーマンスを得るには、Python 3.11 以降での実行を強く推奨します。**

- **依存パッケージ**:  

  - `PyYAML`
  - `tqdm`

  以下のコマンドでインストールできます：

  ```bash
  pip install PyYAML tqdm
  ```

---

## 🎮 使い方

### ▶ 主要スクリプトの実行

ご自身のニーズに基づいて、以下のファイルを選択して実行してください：

- `MainBatch.py`: **一括シミュレーション**。カードプールと課題曲を入力し、自動でデッキを生成して一括シミュレーションを実行します。**単曲での最適デッキ**を見つけるのに役立ちます。
- `MainSingle.py`: **単一シミュレーション**。特定のデッキと課題曲を入力し、一度だけシミュレーションを実行して詳細なプロセスを出力します。
- `multi_song_optimizer.py`: **複数曲最適化**。複数の課題曲を入力し、`MainBatch.py` で生成されたデッキスコアデータを利用して、**複数曲間での最適な組み合わせ**を見つけます。

### ⚙ カスタム設定

必要に応じて、以下のファイル内の設定を調整できます：

- `CardLevelConfig.py`: すべてのカードの**デフォルト練度**と、**個別のカード練度** (`CARD_CACHE`) を設定します。デフォルトでは、すべてのカードは最大レベルに設定されています。
- `DeckGen.py`: デッキ生成ロジックを管理します。ここで**カードの競合ルール** (`CARD_CONFLICT_RULES`) を設定し、デッキ生成時のさらなる枝刈り最適化を実現できます。

---

## ⚠️ **重要警告：CPU 使用率と安定性** ⚠️

> [\!CAUTION]  
> ⚠ **一括シミュレーションはデフォルトで利用可能なすべての CPU スレッドを使用し、実行中の CPU 使用率は通常 99% を超えます。** ⚠  
> **Intel i5-13600KF プロセッサにおいて、長時間フルロードで動作させた後にブルースクリーン（BSOD）が発生した事例が報告されています。**
>
> ご使用の CPU の安定性や冷却に自信がない場合は、**一括シミュレーションを実行する前に以下の対策を強く推奨します**：
>
> - CPU の**電圧を上げる/クロックを下げる**操作を行う。  
> - シミュレーターが使用する**スレッド数を減らす**。 
>
> 予防策として、`MainBatch.py` ファイル内の `num_processes = os.cpu_count() or 1` の行を `num_processes = 12` に変更することができます。`12` は一例であり、パフォーマンスの負荷を軽減するために、ご使用の CPU の**合計スレッド数未満の任意の数値**に置き換えることが可能です。

- **リソースに関する考慮事項**: 理論的には、すべてのカードをカードプールに含めて一括シミュレーションを実行することも可能です。しかし、そのためには**極めて強力な CPU 性能、膨大な RAM 容量、そして十分なシミュレーション時間**が必要です。予期せぬ問題が発生する可能性もあるため、この方法は**おすすめできません**。
- **メモリ蓄積**: 一括処理におけるデッキ生成とシミュレーションの段階はパイプライン形式で動作するため、一時的なメモリ負荷はある程度抑えられます。ですが、**すべてのデッキのシミュレーション結果は完了するまでメモリ上に蓄積され続ける**点にご注意ください。そのため、メモリ不足エラーを避けるためにも、カードプールに過剰にカードを含めるのは避けてください。

---

## 📝 備考と潜在的な差異

- このシミュレーターは、デッキ生成とシミュレーションに**力任せ探索**を使用しています。見つかる「単曲での最適デッキ」は、**与えられたカードプール、練度、および難易度**においてのみ有効です。これは、チャートで指定された正確なタイミングで **All Perfect** を達成するか、（デッキに宴吟子が含まれる場合には）メンタルが 10% 未満になるまで放置し、その後も All Perfect を維持して達成される最適スコアデッキを指します。カードプール、練度、または譜面難易度を調整すると、異なる最適デッキが得られる可能性があります。
- 同様に、**複数曲における最適デッキの組み合わせ**も、カードプール、練度、難易度などの変更によって変動します。
- このシミュレーターを使えば、**ゲーム内でのリハーサル時間を大幅に短縮**できます。しかし、たった一度の試行で**絶対的な最適デッキ**に辿り着くのは、なかなか難しいです。シミュレーターの真価を発揮させるためには、カードスキルへの深い理解が欠かせません。
- **最適デッキ ≠ 最適戦略**。厳密なタイミング合わせや、フレーム単位でのスコア詰め、あるいはスキル条件や効果に応じたカードの練度調整など、シミュレーターでは測れない部分は、ぜひご自身で突き詰めてみてください。
- **グランプリ Pt** の計算時、すべてのメンバーのシーズンファンレベルは **Lv. 10**、センターキャラクター（存在する場合）の凸ボは **1.4 倍**と仮定しています。
- シミュレーターは**ゲームのロジックを完全に再現しているわけではありません**。そのため、シミュレーションスコアが実際のゲーム内スコアと異なる場合がある点は、あらかじめご了承ください。

### ⏰ 潜在的な誤差要因

**ロジックの不一致**  
オリジナルのゲームロジックを完全に再現できていないため、スキル処理やスコア計算の結果が実プレイと大きく異なる可能性があります。  
**実際のプレイ動画、詳細なデッキ練度、および楽曲のマスター Lv. 情報**をご提供いただければ、不一致を検証し、修正を試みる場合があります。

**長押しノート判定点の欠落**  
一部の譜面では、シミュレーターでの解析ノート数に数桁の誤差があり、その一部は`RChartPatch.py`で手動修正されていません。  
譜面内の**カーブした長押しノート**は、実際には複数の短い直線の長押しノートで構成されています。しかし、譜面ファイルに記録されている中間タイムスタンプは、実際のゲーム内の判定点と完全に一致しない場合があります。ゲームは長押しノートのタイムスタンプを半拍間隔で再分割します。
`RChart.py`はこのロジックを再現していますが、**計算精度や計算方法の違い**により、一部の長押しノートで判定点が 1 つ欠落する可能性があります。

**時間処理の誤差**  
**浮動小数点精度問題**またはその他の不明な理由（例えば、ゲームが各イベントの正確なタイムスタンプではなく、フレームごとにすべてのイベントを処理している可能性など）により、実際のスキル発動タイミングが**シミュレーションより数十 ms 早く/遅れる**可能性があります。極端な例として、シミュレーションでは FEVER 直前に発動したボルテージスキルが、実際には FEVER 開始後に発動してしまうケースがあります。これにより、FEVER 开始時に発動したセンタースキルに、肝心のボルテージバフを奪われてしまう、といった事象も報告されています。

**判定タイミング**  
シミュレーターは、判定が Perfect であるかどうかに関わらず、譜面内の正確な`just`タイミングでノートを処理します。  
しかし、実際のゲームプレイでは判定には**時間窓**が存在します。AP が不足している場合、これによりスキル発動タイミングがわずかに早まったり遅れたりする可能性があり、極端なケースではシミュレーションよりもカードの発動回数が増減する可能性があります。  
FEVER 開始・終了時と同一拍にあるノートは、フレーム単位での「最適化」を行うことで、FEVER の 2 倍ボルテージボーナスを得られることがあります。ただ、譜面上のノートのタイムスタンプが実際の FEVER 切り替え時間からわずかにずれているため、シミュレーション上では FEVER 内で処理されない場合があります。  
Ver.4.0.1 時点での判定タイミングを以下の表に示します。参考にご覧ください。

<table>
  <thead>
    <tr>
      <th rowspan="2"><b>判定</b></th>
      <th colspan="3"><b>判定タイミング (ms)</b></th>
    </tr>
    <tr>
      <th><i>Single / Hold</i></th>
      <th><i>Flick</i></th>
      <th><i>Trace</i></th>
    </tr>
  </thead>
  <tbody align="center">
    <tr>
      <td>Perfect</td>
      <td>0 ~ ±40</td>
      <td>0 ~ ±70</td>
      <td>0 ~ ±70</td>
    </tr>
    <tr>
      <td>Great</td>
      <td>±40 ~ ±70</td>
      <td>±70 ~ ±100</td>
      <td>－</td>
    </tr>
    <tr>
      <td>Good</td>
      <td>±70 ~ ±100</td>
      <td>タップのみ</td>
      <td>－</td>
    </tr>
    <tr>
      <td>Bad</td>
      <td>±100 ~ ±125</td>
      <td>－</td>
      <td>－</td>
    </tr>
    <tr>
      <td>Miss</td>
      <td>±125 ~</td>
      <td>±100 ~</td>
      <td>±70 ~</td>
    </tr>
  </tbody>
</table>
